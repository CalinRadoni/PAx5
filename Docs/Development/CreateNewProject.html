<?xml version='1.0' encoding='utf-8' ?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	</head>
	<body>
		<h1 id="CreatinganewprojectbasedonPAx5Base">Creating a new project based on PAx5_Base</h1>
		<p>This document show the steps required to create a new project in 
			<strong>PAx5</strong> workspace based on 
			<em>PAx5_Base</em>.
			<br/>Assumptions:
		</p>
		<ul>
			<li>MCU: 
				<strong>STM32L051K8</strong> MCU 
				<em>(FLASH: 64KB, RAM: 8KB)</em>
			</li>
			<li>IDE: 
				<strong>Atollic TrueSTUDIO for ARM</strong> version 
				<strong>7.0.0</strong>
			</li>
		</ul>
		<h2 id="Createthenewproject">Create the new project</h2>
		<p>To create a new project choose 
			<strong>File -&gt; New -&gt; C++ Project</strong>
		</p>
		<p>
			<strong>Step 1</strong> C++ Project window
		</p>
		<ul>
			<li>Fill Project name</li>
			<li>Project type: 
				<strong>Executable -&gt; Embedded C++ Project</strong>
			</li>
			<li>Toolchains: 
				<strong>Atollic ARM Tools</strong>
			</li>
		</ul>
		<p>
			<strong>Step 2</strong> Hardware configuration
		</p>
		<ul>
			<li>Device: 
				<strong>STM32L051K8</strong>
			</li>
			<li>Floating point: Software implementation</li>
			<li>Code location: 
				<strong>FLASH</strong>
			</li>
			<li>Instruction set: Thumb2</li>
			<li>Endianess: Little endian</li>
		</ul>
		<p>
			<strong>Step 3</strong> Software configuration
		</p>
		<p>Runtime library</p>
		<ul>
			<li>Library: 
				<strong>Reduced C and C++</strong>
			</li>
			<li>Use tiny printf/sprintf/fprintf (small code size): 
				<strong>uncheck</strong>
			</li>
			<li>Generate system calls file (enable I/O redirection and OS integration): 
				<strong>uncheck</strong>
			</li>
		</ul>
		<p>Optimization</p>
		<ul>
			<li>Remove unused code (dead code removal): 
				<strong>check</strong>
			</li>
			<li>Remove unused data (dead data removal): 
				<strong>check</strong>
			</li>
			<li>Disable C++ runtime type information (RTTI): 
				<strong>check</strong>
			</li>
			<li>Disable C++ exception handling: 
				<strong>check</strong>
			</li>
		</ul>
		<p>
			<strong>Step 4</strong> Debugger configuration
		</p>
		<ul>
			<li>Debug Probe: 
				<strong>ST-LINK</strong>
			</li>
		</ul>
		<p>
			<strong>Step 5</strong> Select configurations
		</p>
		<p>Select all</p>
		<h2 id="Postprojectcreationsteps">Post project creation steps</h2>
		<p>
			<strong>Step 1</strong> Linker file
		</p>
		<p>Change the 
			<em>stm32_flash.ld</em> file by adding:
		</p>
		<pre><code>. = ALIGN(4);
*(.RamFunctions)   /* .RamFunctions sections */
</code></pre>
		<p>in 
			<strong>.data:</strong> section. The section should look like this:
		</p>
		<pre><code>.data : 
{
  . = ALIGN(4);
  _sdata = .;        /* create a global symbol at data start */
  *(.data)           /* .data sections */
  *(.data*)          /* .data* sections */
  
  /* added by Calin Radoni for PAx5 RAM functions */
  . = ALIGN(4);
  *(.RamFunctions)   /* .RamFunctions sections */

  . = ALIGN(4);
  _edata = .;        /* define a global symbol at data end */
} &gt;RAM AT&gt; FLASH
</code></pre>
		<p></p>
		<p>
			<strong>Step 2</strong> Drivers folder
		</p>
		<p>
			<strong>TrueStudio 7.0.0</strong> contains CMSIS version 1.0.1 but for PAx5 I have used version 1.2.0 downloaded from ST.
			<br/>Delete the 
			<em>Drivers</em> directory. We will use the one form PAx5_Base.
		</p>
		<h2 id="ProjectSettings">Project Settings</h2>
		<p>In 
			<em>Project Explorer</em> right-click the project&#8217;s name and select 
			<strong>Properties</strong>
		</p>
		<p>
			<strong>Step 1</strong>
		</p>
		<p>To add a path as a 
			<strong>workspace path</strong>, in 
			<strong>Add..</strong> window:
		</p>
		<ul>
			<li>click the 
				<strong>Workspace...</strong> button
			</li>
			<li>select desired path and click 
				<strong>OK</strong>
			</li>
			<li>make sure 
				<strong>Is a workspace path</strong> is 
				<strong>checked</strong> and click 
				<strong>OK</strong>
			</li>
		</ul>
		<p>
			<strong>A:</strong> In 
			<strong>C/C++ General -&gt; Paths and Symbols -&gt; Includes</strong> remove from all configurations (
			<em>Debug, Release</em>) and all languages (
			<em>GNU C, GNU C++ and S,s,asm</em>):
		</p>
		<ul>
			<li>
				<em>Drivers/STM32L0xx_HAL_Driver/Inc</em>
			</li>
			<li>
				<em>Drivers/CMSIS/Include</em>
			</li>
			<li>
				<em>Drivers/CMSIS/Device/ST/STM32L0xx/Include</em>
			</li>
		</ul>
		<p>then click the 
			<strong>Add</strong> button and add as 
			<strong>workspace path</strong>:
		</p>
		<ul>
			<li>
				<em>/PAx5_Base/Drivers/CMSIS/Include</em>
			</li>
			<li>
				<em>/PAx5_Base/Drivers/CMSIS/Device/ST/STM32L0xx/Include</em>
			</li>
		</ul>
		<p>then click the 
			<strong>Apply</strong> button.
		</p>
		<p>For GNU C++ also add as 
			<strong>workspace path</strong>:
		</p>
		<ul>
			<li>
				<em>/PAx5_Base/src/Board</em>
			</li>
			<li>
				<em>/PAx5_Base/src/Comm</em>
			</li>
		</ul>
		<p>then click the 
			<strong>Apply</strong> button.
		</p>
		<p>
			<strong>B:</strong> In 
			<strong>C/C++ General -&gt; Paths and Symbols -&gt; Symbols</strong> remove USE_STDPERIPH_DRIVER from all configurations (
			<em>Debug, Release</em>) and all languages (
			<em>GNU C, GNU C++ and S,s,asm</em>) then click the 
			<strong>Apply</strong> button.
		</p>
		<p>
			<strong>C:</strong> In 
			<strong>C/C++ General -&gt; Paths and Symbols -&gt; Library Paths</strong> select 
			<strong>Debug</strong> configuration, click the 
			<strong>Add</strong> button and add as 
			<strong>workspace path</strong> the 
			<em>/PAx5_Base/Debug</em> location.
		</p>
		<p>
			<strong>D:</strong> Repeat previous step for 
			<strong>Release</strong> configuration but select 
			<em>PAx5_Base/Release</em> location.
		</p>
		<p>
			<strong>E:</strong> In 
			<strong>C/C++ General -&gt; Paths and Symbols -&gt; Library</strong> for all configurations click the 
			<strong>Add</strong> button an enter 
			<strong>PAx5_Base</strong> .
		</p>
		<p>
			<strong>Step 2</strong>
			<br/>In 
			<strong>C/C++ Build -&gt; Settings -&gt; Tool Settings -&gt; C++ Compiler -&gt; Directories</strong>:
		</p>
		<ul>
			<li>click 
				<strong>Add</strong> then 
				<strong>Workspace</strong> and select 
				<strong>PAx5_Base/src/Board</strong> directory
			</li>
			<li>click 
				<strong>Add</strong> then 
				<strong>Workspace</strong> and select 
				<strong>/PAx5_Base/src/Comm</strong> directory
			</li>
		</ul>
		<p>and move them right below 
			<em>../src</em>
		</p>
		<p>
			<strong>Step 3</strong> (optional)
			<br/>In 
			<strong>C/C++ Build -&gt; Settings -&gt; Build Steps</strong> set pre-build and post-build steps.
		</p>
		<p>To have the build number automatically incremented, 
			<strong>Pre-build steps -&gt; Command</strong>
		</p>
		<pre><code>&lt;path_to_BuildNumberInc&gt;\BuildNumberInc.exe -v &lt;path to project's version.h file&gt; &lt;name of define for build number&gt;
</code></pre>
		<p>or</p>
		<pre><code>&lt;path_to_BuildNumberInc&gt;\BuildNumberInc.exe -c -v &lt;path to project's version.h file&gt; &lt;name build number constant&gt;
</code></pre>
		<p>To have more verbose size informations, 
			<strong>Post-build steps -&gt; Command</strong>
		</p>
		<pre><code>arm-atollic-eabi-size.exe --format=sysv -x ..\Release\&lt;project name&gt;.elf
</code></pre>
		<p>
			<strong>Step 4</strong> (optional)
			<br/>In 
			<strong>C/C++ Build -&gt; Setting -&gt; Tool Settings -&gt; Other -&gt; Output format</strong>:
		</p>
		<ul>
			<li>
				<strong>check</strong> Convert build output
			</li>
			<li>select Intel Hex</li>
		</ul>
		<p>
			<strong>Step 5</strong> (optional)
			<br/>In 
			<strong>Project References</strong> 
			<strong>check</strong> 
			<em>PAx5_Base</em>
			<br/>By doing this Rebuild should also rebuild the library. I have seen that it build default library configuration not the one needed for project (Ex. Project with Release and library with Debug).
			<br/>So, better NOT check this until a I find an answer ! 
		</p>
		<p>
			<strong>Step 6</strong>
			<br/>In 
			<strong>Task Repository</strong> select Local
		</p>
		<h2 id="Rundebugconfigurations">Run/debug configurations</h2>
		<p>Build the project.</p>
		<p>Open 
			<strong>Debug Configurations</strong> window (
			<strong>Run -&gt; Debug Configurations...</strong>).
			<br/>Under 
			<strong>Embedded C/C++ Application</strong> duplicate an existing configuration then:
		</p>
		<p>In 
			<strong>Main</strong> tab:
		</p>
		<ul>
			<li>set desired name</li>
			<li>click 
				<strong>Browse...</strong> button located on the right of project name and select this project
			</li>
			<li>click 
				<strong>Search Project...</strong> button and select the 
				<em>elf</em> file corresponding to this project
			</li>
			<li>select 
				<strong>Disable auto build</strong>
			</li>
		</ul>
		<p>In 
			<strong>Common</strong> tab:
		</p>
		<ul>
			<li>for Save As use 
				<strong>Local file</strong>
			</li>
			<li>for Display in favorites menu 
				<strong>check</strong> Debug
			</li>
		</ul>
		<p>In 
			<strong>Startup Scripts</strong> tab, 
			<strong>Target Software Startup Scripts</strong> use one of the following scripts:
		</p>
		<p>
			<strong>Download and reset target configuration</strong>
		</p>
		<pre><code>set host-charset CP1252
set target-charset CP1252
monitor reset
load		
quit
</code></pre>
		<p>Standard 
			<strong>Download and debug</strong> generated by 
			<strong>TrueStudio</strong>
		</p>
		<pre><code># Set character encoding
set host-charset CP1252
set target-charset CP1252

# Reset to known state
monitor reset

# Load the program executable
load		

# Reset the chip to get to a known state. Remove "monitor reset" command 
#  if the code is not located at default address and does not run by reset. 
monitor reset

# Enable Debug connection in low power modes (DBGMCU-&gt;CR)
set *0xE0042004 = (*0xE0042004) | 0x7

# Set a breakpoint at main().
tbreak main

# Run to the breakpoint.
continue
</code></pre>
		<p></p>
		<p>Click the 
			<strong>Apply</strong> button to save the configuration.
		</p>
		<p>If there is no 
			<em>debug</em> drop-down button to select desired dubug configuration, customize current perspective
			<br/>( 
			<strong>Menu: Window -&gt; Perspective -&gt; Customize Perspective...</strong> )
			<br/>In the 
			<strong>Tool Bar Visibility</strong> tab expand the 
			<strong>Launch</strong> item then uncheck and recheck the 
			<strong>Debug</strong> subitem.
		</p>
	</body>
</html>